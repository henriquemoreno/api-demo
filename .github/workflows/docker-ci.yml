name: Deploy Blue/Green + Canary

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login no GHCR (gratuito)
      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # 3Ô∏è‚É£ Build da imagem
      - name: Build image
        run: |
          docker build -t ghcr.io/henriquemoreno/apidemo:${{ github.sha }} .

      # 4Ô∏è‚É£ Push da imagem
      - name: Push image
        run: |
          docker push ghcr.io/henriquemoreno/apidemo:${{ github.sha }}

      # 5Ô∏è‚É£ Garantir permiss√£o dos scripts
      - name: Make deploy scripts executable
        run: chmod +x deploy/*.sh

      # 6Ô∏è‚É£ Deploy do slot GREEN (n√£o troca tr√°fego ainda)
      - name: Deploy GREEN slot
        run: |
          export IMAGE_TAG=${{ github.sha }}
          docker compose up -d apidemo-green

      # 7Ô∏è‚É£ Aguarda GREEN ficar READY
      - name: Wait GREEN readiness
        run: ./deploy/wait-for-ready.sh apidemo-green

      # 8Ô∏è‚É£ Habilita Canary (10% GREEN)
      - name: Enable Canary (10%)
        run: ./deploy/enable-canary.sh green 10

      # 9Ô∏è‚É£ Soak time (observa√ß√£o m√≠nima)
      - name: Canary soak
        run: sleep 60

      # üîü Smoke test via NGINX
      - name: Smoke Test
        run: curl -f http://localhost:8080/health

      # 1Ô∏è‚É£1Ô∏è‚É£ Promove GREEN para 100%
      - name: Promote Canary to 100%
        run: ./deploy/promote-canary.sh

      # 1Ô∏è‚É£2Ô∏è‚É£ Rollback autom√°tico se QUALQUER passo falhar
      - name: Rollback on failure
        if: failure()
        run: ./deploy/rollback-canary.sh
